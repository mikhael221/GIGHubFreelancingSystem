@model Freelancing.Models.DocumentVerificationViewModel
@{
    ViewData["Title"] = "Document Verification";
    Layout = User.IsInRole("Client") ? "_LayoutClient" : "_LayoutFreelancer";
}

<div class="p-4 sm:ml-64">
    <div class="p-4 mt-20">
        <div class="mt-4">
            <div class="block w-full p-6">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">

                                <!-- Progress Bar -->
                                <div class="w-full max-w-md mx-auto mb-7">
                                    <div class="w-full bg-[#6ce5e8] rounded-full h-7">
                                        <div class="bg-[#41b8d5] h-7 rounded-full transition-all duration-500 ease-in-out" style="width: 50%"></div>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="max-w-2xl mx-auto">

                                        <form asp-action="Document" asp-controller="IdentityVerification" method="post" enctype="multipart/form-data" id="documentForm">

                                            <!-- Document Verification Section -->
                                            <div class="mb-5">
                                                <div class="section-header mb-4 text-center">
                                                    <h3 class="text-3xl font-bold text-gray-800 mb-1">
                                                        ID Document Information
                                                    </h3>
                                                </div>

                                                <div class="card">
                                                    <div class="card-body p-4">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="mb-7">
                                                                    <label asp-for="IdDocumentType" class="form-label ml-2 font-light">Select your ID type <span class="text-red-500">*</span></label>
                                                                    <div class="space-y-4 mt-3">
                                                                        <div class="flex items-center justify-between ps-4 pe-4 bg-gray-100 text-gray-900 text-sm rounded-lg hover:bg-[#6ce5e8] transition-colors cursor-pointer" onclick="selectRadio('PASSPORT')">
                                                                            <label for="radio-passport" class="py-4 text-sm font-medium text-gray-900 cursor-pointer">Passport</label>
                                                                            <input id="radio-passport" type="radio" value="PASSPORT" name="IdDocumentType" asp-for="IdDocumentType" required class="w-4 h-4 text-[#41b8d5] bg-gray-100 border-gray-400 focus:ring-[#41b8d5] focus:ring-2">
                                                                        </div>
                                                                        <div class="flex items-center justify-between ps-4 pe-4 bg-gray-100 text-gray-900 text-sm rounded-lg hover:bg-[#6ce5e8] transition-colors cursor-pointer" onclick="selectRadio('DRIVERS_LICENSE')">
                                                                            <label for="radio-drivers" class="py-4 text-sm font-medium text-gray-900 cursor-pointer">Driver's License</label>
                                                                            <input id="radio-drivers" type="radio" value="DRIVERS_LICENSE" name="IdDocumentType" asp-for="IdDocumentType" required class="w-4 h-4 text-[#41b8d5] bg-gray-100 border-gray-400 focus:ring-[#41b8d5] focus:ring-2">
                                                                        </div>
                                                                        <div class="flex items-center justify-between ps-4 pe-4 bg-gray-100 text-gray-900 text-sm rounded-lg hover:bg-[#6ce5e8] transition-colors cursor-pointer" onclick="selectRadio('NATIONAL_ID')">
                                                                            <label for="radio-national" class="py-4 text-sm font-medium text-gray-900 cursor-pointer">National ID</label>
                                                                            <input id="radio-national" type="radio" value="NATIONAL_ID" name="IdDocumentType" asp-for="IdDocumentType" required class="w-4 h-4 text-[#41b8d5] bg-gray-100 border-gray-400 focus:ring-[#41b8d5] focus:ring-2">
                                                                        </div>
                                                                        <div class="flex items-center justify-between ps-4 pe-4 bg-gray-100 text-gray-900 text-sm rounded-lg hover:bg-[#6ce5e8] transition-colors cursor-pointer" onclick="selectRadio('OTHERS')">
                                                                            <label for="radio-others" class="py-4 text-sm font-medium text-gray-900 cursor-pointer">Others</label>
                                                                            <input id="radio-others" type="radio" value="OTHERS" name="IdDocumentType" asp-for="IdDocumentType" required class="w-4 h-4 text-[#41b8d5] bg-gray-100 border-gray-400 focus:ring-[#41b8d5] focus:ring-2">
                                                                        </div>
                                                                    </div>
                                                                    <span asp-validation-for="IdDocumentType" class="text-danger"></span>
                                                                </div>

                                                                <div class="grid gap-4 mb-7 grid-cols-2">
                                                                    <div class="col-span-2 sm:col-span-1">
                                                                        <label asp-for="IdDocumentNumber" class="form-label ml-2 font-light mb-3">ID Number <span class="text-red-500">*</span></label>
                                                                        <input asp-for="IdDocumentNumber" class="mt-3 form-control bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5" placeholder="Enter your ID number" required />
                                                                        <span asp-validation-for="IdDocumentNumber" class="text-danger"></span>
                                                                    </div>

                                                                    <div class="col-span-2 sm:col-span-1">
                                                                        <label asp-for="IdDocumentExpiryDate" class="form-label ml-2 font-light mb-3">Expiry Date <span class="text-red-500" id="expiryRequired">*</span></label>
                                                                        <input asp-for="IdDocumentExpiryDate" type="date" class="mt-3 form-control bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:ring-2 block w-full p-2.5" value="@(Model.IdDocumentExpiryDate?.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" />
                                                                        <span asp-validation-for="IdDocumentExpiryDate" class="text-danger"></span>
                                                                        <div class="flex items-center mt-2">
                                                                            <input asp-for="IdDocumentHasNoExpiration" id="noExpirationCheckbox" type="checkbox" class="w-4 h-4 text-[#41b8d5] bg-gray-100 border-gray-300 rounded-sm focus:ring-[#41b8d5] focus:ring-2">
                                                                            <label for="noExpirationCheckbox" class="ms-2 text-sm font-light text-gray-900">My ID document has no expiration date</label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    @if (!string.IsNullOrEmpty(Model.IdDocumentType) && !string.IsNullOrEmpty(Model.IdDocumentNumber))
                                                                    {
                                                                        <!-- Show optional file upload for returning users -->
                                                                        <label asp-for="IdDocumentImage" class="form-label ml-2 font-light mb-3">
                                                                            Upload New Document
                                                                            <span class="text-gray-400">(Optional)</span>
                                                                        </label>
                                                                        <input asp-for="IdDocumentImage" type="file" class="mt-3 form-control block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" aria-describedby="file_input_help" accept="image/*">
                                                                        <p class="mt-1 text-sm text-gray-500" id="file_input_help">Upload a new document or leave empty to use the existing one (Max: 10MB)</p>
  
                                                                        <!-- Document Preview - Moved below upload instructions -->
                                                                        <div class="mt-4">
                                                                            <div class="relative inline-block">
                                                                                @if (ViewBag.StoredImageData != null)
                                                                                {
                                                                                    <!-- Show actual uploaded image -->
                                                                                    <div id="existingImagePreview" class="w-40 h-24 rounded-lg border-2 border-gray-300 transition-colors shadow-sm overflow-hidden">
                                                                                        <img src="data:@ViewBag.StoredImageContentType;base64,@ViewBag.StoredImageData"
                                                                                             alt="Uploaded Document"
                                                                                             class="w-full h-full object-cover">
                                                                                        
                                                                                        <!-- Verification Badge -->
                                                                                        <div class="absolute top-0 right-0 bg-green-500 text-white text-xs px-2 py-1 rounded-full transform translate-x-1/2 -translate-y-1/2">
                                                                                            ✓
                                                                                        </div>
                                                                                    </div>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <!-- Show realistic ID Card Preview when no image stored -->
                                                                                    <div id="existingImagePreview" class="w-40 h-24 bg-white rounded-lg border-2 border-gray-300 transition-colors shadow-sm overflow-hidden"
                                                                                         onclick="showDocumentPreview()">
                                                                                        <!-- Realistic ID Card Preview -->
                                                                                        <div class="w-full h-full bg-gradient-to-br from-blue-50 to-blue-100 p-2 relative">
                                                                                            <!-- Philippine Flag Emblem -->
                                                                                            <div class="absolute top-1 left-1 w-4 h-3 bg-gradient-to-r from-blue-600 via-red-500 to-yellow-400 rounded-sm"></div>
                                                                                            
                                                                                            <!-- Photo Placeholder -->
                                                                                            <div class="absolute top-1 left-6 w-8 h-10 bg-gray-300 rounded-sm flex items-center justify-center">
                                                                                                <div class="text-xs text-gray-600">👤</div>
                                                                                            </div>
                                                                                            
                                                                                            <!-- ID Text -->
                                                                                            <div class="absolute top-1 left-16 right-1">
                                                                                                <div class="text-xs font-bold text-gray-800">REPUBLIKA NG</div>
                                                                                                <div class="text-xs font-bold text-gray-800">PILIPINAS</div>
                                                                                            </div>
                                                                                            
                                                                                            <!-- Personal Details -->
                                                                                            <div class="absolute top-12 left-6 right-1 text-xs text-gray-700">
                                                                                                <div>Name: <span class="font-medium">CADJET SENOBEA</span></div>
                                                                                                <div>DOB: <span class="font-medium">APRIL 22, 2004</span></div>
                                                                                            </div>
                                                                                            
                                                                                            <!-- QR Code Placeholder -->
                                                                                            <div class="absolute top-1 right-1 w-6 h-6 bg-black rounded-sm flex items-center justify-center">
                                                                                                <div class="text-xs text-white">QR</div>
                                                                                            </div>
                                                                                            
                                                                                            <!-- Country Code -->
                                                                                            <div class="absolute bottom-1 right-1 text-xs font-bold text-gray-800">PHL</div>
                                                                                        </div>
                                                                                        
                                                                                        <!-- Verification Badge -->
                                                                                        <div class="absolute top-0 right-0 bg-green-500 text-white text-xs px-2 py-1 rounded-full transform translate-x-1/2 -translate-y-1/2">
                                                                                            ✓
                                                                                        </div>
                                                                                    </div>
                                                                                }
                                                                                <p class="text-xs text-gray-600 mt-1">Uploaded ID</p>
                                                                            </div>
                                                                        </div>
  
                                                                        <!-- New Image Preview -->
                                                                        <div id="newImagePreview" class="mt-3" style="display: none;">
                                                                            <img id="newImage" src="" alt="New Document Preview"
                                                                                 class="w-32 h-20 object-cover rounded-lg border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition-colors"
                                                                                 onclick="showImageModal(this.src, 'New Document Preview')">
                                                                            <p class="text-xs text-gray-600 mt-1">Click to enlarge</p>
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <!-- Show required file upload for new submissions -->
                                                                        <label asp-for="IdDocumentImage" class="form-label ml-2 font-light mb-3">Upload ID Document <span class="text-red-500">*</span></label>
                                                                        <input asp-for="IdDocumentImage" type="file" class="mt-3 form-control block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" aria-describedby="file_input_help" accept="image/*" required>
                                                                        <p class="mt-1 text-sm text-gray-500" id="file_input_help">Upload a clear, high-resolution image of your ID document (Max: 10MB)</p>
  
                                                                        <!-- New Image Preview -->
                                                                        <div id="newImagePreview" class="mt-3" style="display: none;">
                                                                            <img id="newImage" src="" alt="Document Preview"
                                                                                 class="w-32 h-20 object-cover rounded-lg border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition-colors"
                                                                                 onclick="showImageModal(this.src, 'Document Preview')">
                                                                            <p class="text-xs text-gray-600 mt-1">Click to enlarge</p>
                                                                        </div>
                                                                    }
                                                                    <span asp-validation-for="IdDocumentImage" class="text-danger"></span>
                                                                    <div id="fileError" class="text-red-500 text-sm mt-1" style="display: none;"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Navigation Buttons -->
                                            <div class="text-end">
                                                <a href="@Url.Action("Index", "IdentityVerification")" class="btn btn-secondary btn-lg me-3">
                                                    <i class="fas fa-arrow-left me-2"></i>Back
                                                </a>
                                                <button type="submit" class="btn text-white bg-[#41b8d5] focus:ring-4 focus:ring-[#6ce5e8] font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 focus:outline-none" id="nextBtn">
                                                    Continue
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 backdrop-blur-sm bg-black/30 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-4 max-w-2xl max-h-2xl overflow-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800"></h3>
            <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
        </div>
        <img id="modalImage" src="" alt="Document Image" class="w-full h-auto rounded-lg">
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Populate form fields with existing data if available
            @if (!string.IsNullOrEmpty(Model.IdDocumentType))
            {
                <text>
                // Set the selected ID document type
                $('input[name="IdDocumentType"][value="@Model.IdDocumentType"]').prop('checked', true);
                selectRadio('@Model.IdDocumentType');

                // Set the ID document number
                $('#IdDocumentNumber').val('@Model.IdDocumentNumber');

                // Set the expiry date
                @if (Model.IdDocumentExpiryDate.HasValue)
                {
                    <text>$('#IdDocumentExpiryDate').val('@Model.IdDocumentExpiryDate.Value.ToString("yyyy-MM-dd")');</text>
                }

                // Set the no expiration checkbox
                if (@Model.IdDocumentHasNoExpiration.ToString().ToLower()) {
                    $('#noExpirationCheckbox').prop('checked', true);
                    $('#IdDocumentExpiryDate').prop('disabled', true).val('').removeAttr('required');
                    $('#expiryRequired').hide();
                }
                </text>
            }

            // Handle "No Expiration Date" checkbox
            $('#noExpirationCheckbox').on('change', function() {
                var expiryDateInput = $('#IdDocumentExpiryDate');
                var expiryRequired = $('#expiryRequired');
                if (this.checked) {
                    expiryDateInput.prop('disabled', true).val('').removeAttr('required');
                    expiryRequired.hide();
                } else {
                    expiryDateInput.prop('disabled', false).val('@DateTime.Today.ToString("yyyy-MM-dd")').attr('required', 'required');
                    expiryRequired.show();
                }
            });

            // Set initial state based on checkbox
            if ($('#noExpirationCheckbox').is(':checked')) {
                $('#IdDocumentExpiryDate').prop('disabled', true).val('');
            }

            // File validation and preview
            $('input[type="file"]').on('change', function() {
                var file = this.files[0];
                var fileError = $('#fileError');
                var newImagePreview = $('#newImagePreview');
                var newImage = $('#newImage');

                // Reset error message and hide preview
                fileError.hide();
                newImagePreview.hide();

                if (file) {
                    // Check file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        fileError.text('File size must be less than 10MB').show();
                        this.value = ''; // Clear the file input
                        return false;
                    }

                    // Check file type
                    var allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
                    if (!allowedTypes.includes(file.type)) {
                        fileError.text('Please upload a valid image file (JPEG, PNG, GIF, BMP)').show();
                        this.value = ''; // Clear the file input
                        return false;
                    }

                    // Show image preview
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        newImage.attr('src', e.target.result);
                        newImagePreview.show();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Form submission handling
            $('#documentForm').on('submit', function(e) {
                // Clear any previous error messages
                $('#fileError').hide();

                // Validate that an ID type is selected
                var selectedIdType = $('input[name="IdDocumentType"]:checked').val();
                if (!selectedIdType) {
                    e.preventDefault();
                    alert('Please select an ID document type before proceeding.');
                    return false;
                }

                // Validate file upload - only required for new submissions
                var fileInput = $('input[type="file"]')[0];
                var isReturningUser = @(!string.IsNullOrEmpty(Model.IdDocumentType) && !string.IsNullOrEmpty(Model.IdDocumentNumber)).ToString().toLowerCase();
                
                // For returning users, file upload is optional
                if (isReturningUser === 'true') {
                    // User is returning, file upload is optional
                } else {
                    // New user, file upload is required
                    if (!fileInput.files || fileInput.files.length === 0) {
                        e.preventDefault();
                        $('#fileError').text('Please select a file to upload').show();
                        return false;
                    }
                }

                // If there's a file, validate it
                if (fileInput.files && fileInput.files.length > 0) {
                    var file = fileInput.files[0];

                    // Check file size again
                    if (file.size > 10 * 1024 * 1024) {
                        e.preventDefault();
                        $('#fileError').text('File size must be less than 10MB').show();
                        return false;
                    }

                    // Check file type again
                    var allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
                    if (!allowedTypes.includes(file.type)) {
                        e.preventDefault();
                        $('#fileError').text('Please upload a valid image file (JPEG, PNG, GIF, BMP)').show();
                        return false;
                    }
                }

                // Show loading state
                $('#nextBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...');

                // Allow form to submit normally
                return true;
            });
        });

        // Function to handle radio button selection with visual feedback
        function selectRadio(value) {
            // Uncheck all radio buttons
            $('input[name="IdDocumentType"]').prop('checked', false);

            // Check the selected radio button
            $(`input[value="${value}"]`).prop('checked', true);

            // Remove active styling from all radio containers
            $('.space-y-4 > div').removeClass('bg-blue-100 border-blue-300').addClass('bg-gray-100');

            // Add active styling to selected container
            $(`input[value="${value}"]`).closest('div').removeClass('bg-gray-100').addClass('bg-[#6ce5e8] border-[#6ce5e8]');
        }

        // Function to show image modal
        function showImageModal(imageSrc, title) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalImage').style.display = 'block';
            document.getElementById('imageModal').classList.remove('hidden');
        }

        // Function to show document preview modal
        function showDocumentPreview() {
            @if (ViewBag.StoredImageData != null)
            {
                <text>
                // Show actual uploaded image in modal
                document.getElementById('modalImage').style.display = 'block';
                document.getElementById('modalTitle').textContent = 'Previously Uploaded Document';
                document.getElementById('modalImage').src = 'data:@ViewBag.StoredImageContentType;base64,@ViewBag.StoredImageData';
                document.getElementById('imageModal').classList.remove('hidden');
                </text>
            }
        }

        // Function to close image modal
        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
}
